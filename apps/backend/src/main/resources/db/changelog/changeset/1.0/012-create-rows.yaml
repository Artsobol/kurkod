databaseChangeLog:
    - changeSet:
        id: 001-create-rows
        author: artsobol
        preConditions:
          - onFail: HALT
            and:
              - tableExists:
                  tableName: workshop
              - not:
                  tableExists:
                    tableName: rows

        changes:
          - createTable:
              tableName: rows
              columns:
                - column:
                    name: id
                    type: bigserial
                    constraints:
                      primaryKey: true
                      primaryKeyName: pk_rows
                      nullable: false

                - column:
                    name: row_number
                    type: integer
                    constraints:
                      nullable: false
                      checkConstraint: row_number > 0

                - column:
                    name: workshop_id
                    type: bigint
                    constraints:
                      nullable: false

                - column:
                    name: created_at
                    type: timestamp with time zone
                    defaultValueComputed: now()
                    constraints:
                      nullable: false

                - column:
                    name: updated_at
                    type: timestamp with time zone
                    defaultValueComputed: now()
                    constraints:
                      nullable: false

                - column:
                    name: is_active
                    type: boolean
                    defaultValueBoolean: true
                    constraints:
                      nullable: false

                - column:
                    name: version
                    type: bigint
                    defaultValue: "0"
                    constraints:
                      nullable: false

          - addForeignKeyConstraint:
              baseTableName: rows
              baseColumnNames: workshop_id
              constraintName: fk_rows_workshop_id
              referencedTableName: workshop
              referencedColumnNames: id
              onDelete: RESTRICT
              onUpdate: RESTRICT

          - addUniqueConstraint:
              tableName: rows
              columnNames: workshop_id, row_number
              constraintName: uq_rows_workshop_id_row_number

          - createIndex:
              tableName: rows
              indexName: idx_rows_workshop_id
              columns:
                - column:
                    name: workshop_id

        rollback:
          - dropForeignKeyConstraint:
              baseTableName: rows
              constraintName: fk_rows_workshop_id
          - dropUniqueConstraint:
              tableName: rows
              constraintName: uq_rows_workshop_id_row_number
          - dropIndex:
              tableName: rows
              indexName: idx_rows_workshop_id
          - dropTable:
              tableName: rows
