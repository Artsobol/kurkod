databaseChangeLog:
    - changeSet:
        id: 001-create-cage
        author: artsobol
        preConditions:
          - onFail: HALT
            and:
              - not:
                  tableExists:
                    tableName: cage
              - tableExists:
                    tableName: rows

        changes:
          - createTable:
              tableName: cage
              columns:
                - column:
                    name: id
                    type: bigserial
                    constraints:
                      primaryKey: true
                      primaryKeyName: pk_cage
                      nullable: false

                - column:
                    name: cage_number
                    type: integer
                    constraints:
                      nullable: false

                - column:
                    name: row_id
                    type: bigint
                    constraints:
                      nullable: false

                - column:
                    name: created_at
                    type: timestamp with time zone
                    defaultValueComputed: now()
                    constraints:
                      nullable: false

                - column:
                    name: updated_at
                    type: timestamp with time zone
                    defaultValueComputed: now()
                    constraints:
                      nullable: false

                - column:
                    name: is_active
                    type: boolean
                    defaultValueBoolean: true
                    constraints:
                      nullable: false

                - column:
                    name: version
                    type: bigint
                    defaultValueNumeric: "0"
                    constraints:
                      nullable: false

          - addForeignKeyConstraint:
              baseTableName: cage
              baseColumnNames: row_id
              constraintName: fk_cage_row_id
              referencedTableName: rows
              referencedColumnNames: id
              onDelete: RESTRICT
              onUpdate: RESTRICT

          - addUniqueConstraint:
              tableName: cage
              columnNames: row_id, cage_number
              constraintName: uq_cage_row_id_cage_number

          - addCheckConstraint:
              tableName: cage
              constraintName: ck_cage_number_number_gt_0
              constraintBody: "cage_number > 0"

        rollback:
          - dropForeignKeyConstraint:
              baseTableName: cage
              constraintName: fk_cage_row_id
          - dropUniqueConstraint:
              tableName: cage
              constraintName: uq_cage_row_id_cage_number
          - dropCheckConstraint:
              tableName: cage
              constraintName: ck_cage_number_gt_0
          - dropTable:
              tableName: cage